{% extends "base.html" %}
{% block content %}
<div class="space-y-8">
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-2xl font-semibold tracking-tight flex items-center gap-2"><i class="fas fa-clipboard-list text-primary-600"></i><span>Manage Claims</span></h1>
            <p class="text-sm text-gray-600">Review and process item claim submissions.</p>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-gray-50"><i class="fas fa-arrow-left"></i>Dashboard</a>
    </div>

    <!-- Filters -->
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b px-5 py-3"><h2 class="text-sm font-semibold tracking-wide flex items-center gap-2"><i class="fas fa-filter text-primary-500"></i>Filters & Sorting</h2></div>
        <div class="p-5">
            <form method="GET" action="{{ url_for('admin_claims') }}" class="grid gap-4 md:grid-cols-4">
                <div class="space-y-1"><label class="text-xs font-medium text-gray-600" for="status">Status</label><select name="status" id="status" class="w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500"><option value="all" {% if status_filter=='all' %}selected{% endif %}>All Status</option><option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending</option><option value="approved" {% if status_filter=='approved' %}selected{% endif %}>Approved</option><option value="rejected" {% if status_filter=='rejected' %}selected{% endif %}>Rejected</option></select></div>
                <div class="space-y-1"><label class="text-xs font-medium text-gray-600" for="item_type">Item Type</label><select name="item_type" id="item_type" class="w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500"><option value="all" {% if item_type_filter=='all' %}selected{% endif %}>All Types</option><option value="lost" {% if item_type_filter=='lost' %}selected{% endif %}>Lost Items</option><option value="found" {% if item_type_filter=='found' %}selected{% endif %}>Found Items</option></select></div>
                <div class="space-y-1"><label class="text-xs font-medium text-gray-600" for="sort">Sort By</label><select name="sort" id="sort" class="w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500"><option value="created_at" {% if sort_by=='created_at' %}selected{% endif %}>Date Created</option><option value="full_names" {% if sort_by=='full_names' %}selected{% endif %}>Claimant Name</option><option value="status" {% if sort_by=='status' %}selected{% endif %}>Status</option><option value="item_type" {% if sort_by=='item_type' %}selected{% endif %}>Item Type</option></select></div>
                <div class="space-y-1"><label class="text-xs font-medium text-gray-600" for="order">Order</label><select name="order" id="order" class="w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500"><option value="desc" {% if sort_order=='desc' %}selected{% endif %}>Descending</option><option value="asc" {% if sort_order=='asc' %}selected{% endif %}>Ascending</option></select></div>
                <div class="md:col-span-4 flex justify-end pt-2"><button type="submit" class="inline-flex items-center gap-2 rounded-md bg-primary-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-primary-700"><i class="fas fa-magnifying-glass"></i>Apply Filters</button></div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden">
        <div class="flex items-center justify-between border-b px-5 py-3"><h2 class="text-sm font-semibold tracking-wide flex items-center gap-2"><i class="fas fa-list text-primary-500"></i>Claims ({{ claims.total }} total)</h2></div>
        <div class="overflow-x-auto">
            {% if claims.items %}
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-left text-xs uppercase tracking-wide text-gray-600">
                    <tr>
                        <th class="px-4 py-2 font-semibold">ID</th>
                        <th class="px-4 py-2 font-semibold">Claimant</th>
                        <th class="px-4 py-2 font-semibold">Student #</th>
                        <th class="px-4 py-2 font-semibold">Email</th>
                        <th class="px-4 py-2 font-semibold">Item Type</th>
                        <th class="px-4 py-2 font-semibold">Description</th>
                        <th class="px-4 py-2 font-semibold">Status</th>
                        <th class="px-4 py-2 font-semibold">Admin Notes</th>
                        <th class="px-4 py-2 font-semibold">Date</th>
                        <th class="px-4 py-2 font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for claim in claims.items %}
                    {% set type_badge = 'bg-gray-100 text-gray-700' %}
                    {% if claim.item_type=='lost' %}{% set type_badge='bg-red-100 text-red-700' %}{% elif claim.item_type=='found' %}{% set type_badge='bg-indigo-100 text-indigo-700' %}{% endif %}
                    {% set status_badge = 'bg-gray-100 text-gray-700' %}
                    {% if claim.status=='pending' %}{% set status_badge='bg-amber-100 text-amber-700' %}
                    {% elif claim.status=='approved' %}{% set status_badge='bg-emerald-100 text-emerald-700' %}
                    {% elif claim.status=='rejected' %}{% set status_badge='bg-red-100 text-red-700' %}{% endif %}
                    <tr class="hover:bg-gray-50/70">
                        <td class="px-4 py-2 font-medium text-gray-800">{{ claim.id }}</td>
                        <td class="px-4 py-2 text-gray-700">{{ claim.full_names }}</td>
                        <td class="px-4 py-2 text-gray-600">{{ claim.student_number }}</td>
                        <td class="px-4 py-2 text-gray-600">{{ claim.student_email }}</td>
                        <td class="px-4 py-2"><span class="inline-flex rounded-full px-2.5 py-1 text-xs font-semibold {{ type_badge }}">{{ claim.item_type }}</span></td>
                        <td class="px-4 py-2 text-gray-600">{{ claim.description[:50] }}{% if claim.description|length>50 %}...{% endif %}</td>
                        <td class="px-4 py-2"><span class="inline-flex rounded-full px-2.5 py-1 text-xs font-semibold {{ status_badge }}">{{ claim.status }}</span></td>
                        <td class="px-4 py-2 text-gray-600">{{ claim.admin_notes[:30] if claim.admin_notes else 'No notes' }}{% if claim.admin_notes and claim.admin_notes|length>30 %}...{% endif %}</td>
                        <td class="px-4 py-2 text-gray-600">{{ claim.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="px-4 py-2 w-[160px]">
                            <div class="flex flex-col gap-2">
                                <button type="button" class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow hover:bg-indigo-700" data-claim-id="{{ claim.id }}" data-claim-status="{{ claim.status }}" data-claim-notes="{{ claim.admin_notes or '' }}" onclick="openClaimDialog(this)"><i class="fas fa-pen mr-1"></i>Edit</button>
                                <form method="POST" action="{{ url_for('admin_delete_claim', claim_id=claim.id) }}" onsubmit="return confirm('Delete this claim?')">
                                    <button type="submit" class="inline-flex items-center justify-center rounded-md bg-red-600 px-3 py-1.5 text-xs font-semibold text-white shadow hover:bg-red-700"><i class="fas fa-trash mr-1"></i>Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="p-6 text-center text-sm text-gray-500">No claims found matching filters.</p>
            {% endif %}
        </div>
        {% if claims.items %}
        <div class="border-t bg-gray-50 px-4 py-3 flex items-center justify-between text-xs text-gray-600">
            <div>Page {{ claims.page }} of {{ claims.pages }}</div>
            <div class="flex items-center gap-2">{% if claims.has_prev %}<a href="{{ url_for('admin_claims', page=claims.prev_num, status=status_filter, item_type=item_type_filter, sort=sort_by, order=sort_order) }}" class="inline-flex items-center rounded-md border border-gray-200 bg-white px-2 py-1 font-medium hover:bg-gray-50">Prev</a>{% else %}<span class="inline-flex items-center rounded-md border border-gray-100 bg-gray-100 px-2 py-1 text-gray-400">Prev</span>{% endif %}{% if claims.has_next %}<a href="{{ url_for('admin_claims', page=claims.next_num, status=status_filter, item_type=item_type_filter, sort=sort_by, order=sort_order) }}" class="inline-flex items-center rounded-md border border-gray-200 bg-white px-2 py-1 font-medium hover:bg-gray-50">Next</a>{% else %}<span class="inline-flex items-center rounded-md border border-gray-100 bg-gray-100 px-2 py-1 text-gray-400">Next</span>{% endif %}</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Claim Update Dialog -->
<div id="claimDialog" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeClaimDialog()"></div>
    <div class="relative mx-auto mt-24 w-full max-w-lg px-4">
        <div class="rounded-xl border border-gray-200 bg-white shadow-xl">
            <div class="flex items-center justify-between border-b px-5 py-3">
                <h3 id="claimDialogTitle" class="text-sm font-semibold tracking-wide flex items-center gap-2"><i class="fas fa-pen text-primary-500"></i>Update Claim</h3>
                <button type="button" onclick="closeClaimDialog()" class="rounded-md p-1 text-gray-500 hover:bg-gray-100"><i class="fas fa-xmark"></i></button>
            </div>
            <form id="claimUpdateForm" method="POST" class="p-5 space-y-5">
                {{ form.hidden_tag() }}
                <div class="space-y-1">
                    <label for="claim_status" class="text-xs font-medium text-gray-600">Status</label>
                    <select id="claim_status" name="status" class="w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500" required>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="claim_notes" class="text-xs font-medium text-gray-600">Admin Notes</label>
                    <textarea id="claim_notes" name="admin_notes" rows="4" placeholder="Internal notes (optional)" class="w-full resize-none rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
                </div>
                <div class="flex items-center justify-end gap-2 pt-2">
                    <button type="button" onclick="closeClaimDialog()" class="inline-flex items-center rounded-md border border-gray-200 bg-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-primary-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-primary-700"><i class="fas fa-save"></i>Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openClaimDialog(btn){
    const id = btn.getAttribute('data-claim-id');
    const status = btn.getAttribute('data-claim-status');
    const notes = btn.getAttribute('data-claim-notes') || '';
    document.getElementById('claimDialogTitle').innerHTML = '<i class="fas fa-pen text-primary-500"></i> Update Claim #' + id;
    document.getElementById('claim_status').value = status;
    document.getElementById('claim_notes').value = notes;
    const form = document.getElementById('claimUpdateForm');
    form.action = '/admin/update-claim/' + id;
    document.getElementById('claimDialog').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}
function closeClaimDialog(){
    document.getElementById('claimDialog').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}
</script>
{% endblock %}